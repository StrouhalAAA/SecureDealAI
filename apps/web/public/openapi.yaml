openapi: 3.0.3
info:
  title: SecureDealAI API
  description: |
    REST API for SecureDealAI - a vehicle purchase validation service that uses a
    **Backend-for-Frontend (BFF)** architecture to aggregate data from multiple sources.

    ## üèóÔ∏è BFF Architecture Overview

    SecureDealAI implements a multi-function BFF architecture using **Supabase Edge Functions**
    (Deno/TypeScript). The BFF layer aggregates data from multiple backend services and presents
    optimized, unified responses for the Vue.js frontend.

    ### Why BFF?
    - **Data Aggregation**: Combine data from 7+ sources into single API responses
    - **Service Orchestration**: Coordinate calls to ARES, ADIS, and Mistral OCR APIs
    - **Response Transformation**: Normalize data formats across different sources
    - **Graceful Degradation**: Continue validation even when external services are unavailable
    - **Caching Strategy**: Reduce external API calls with intelligent caching (ARES: 24h, ADIS: 4h)

    ### Data Sources Integrated

    | Source | Type | Purpose | Cache TTL |
    |--------|------|---------|-----------|
    | **Supabase DB** | PostgreSQL | Primary data storage | N/A |
    | **ARES API** | REST | Czech company registry lookup | 24 hours |
    | **ADIS API** | SOAP | VAT payer status verification | 4 hours |
    | **Mistral OCR** | AI/REST | Document text extraction | Permanent |
    | **Supabase Storage** | S3-compatible | Document file storage | N/A |

    ### Key BFF Functions

    | Function | Type | Aggregation | Description |
    |----------|------|-------------|-------------|
    | `validation-run` | Primary BFF | HIGH | Orchestrates validation across 7 DB tables + cached external data |
    | `ares-validate` | Secondary BFF | HIGH | Coordinates ARES REST + ADIS SOAP APIs |
    | `ocr-extract` | Async BFF | HIGH | Processes documents via Mistral OCR with retry logic |
    | `ares-lookup` | Utility BFF | MEDIUM | Real-time company lookup with 24h caching |

    ### Production Environment Simulation

    This Supabase-based architecture simulates how the production Aures deployment would work:
    - **Supabase Edge Functions** ‚Üí Aures BFF API Layer
    - **Supabase PostgreSQL** ‚Üí Aures Production Database
    - **ARES/ADIS APIs** ‚Üí Same external registries (production-ready)
    - **Mistral OCR** ‚Üí Same or equivalent OCR service

    ---

    ## üìã Validation Rules System

    Rules are stored as JSON in PostgreSQL and can be managed without code deployments.
    Each rule defines a comparison between source data (manual input) and target data (OCR/external registries).

    ### Validation Status Logic
    - **üî¥ RED** (blocked): Any CRITICAL rule fails with MISMATCH
    - **üü† ORANGE** (manual review): Any WARNING rule fails OR CRITICAL rule has MISSING data
    - **üü¢ GREEN** (approved): All rules pass

    ### Data Transformation Pipeline
    Before comparison, data passes through configurable transforms:
    - Text: `UPPERCASE`, `LOWERCASE`, `TRIM`, `REMOVE_SPACES`, `REMOVE_DIACRITICS`
    - Format: `NORMALIZE_DATE`, `EXTRACT_NUMBER`, `FORMAT_RC`, `FORMAT_ICO`, `FORMAT_DIC`
    - Domain: `ADDRESS_NORMALIZE`, `NAME_NORMALIZE`, `VIN_NORMALIZE`, `SPZ_NORMALIZE`

    ### Comparison Algorithms
    - `EXACT` - String equality
    - `FUZZY` - Levenshtein similarity (0.0-1.0 threshold)
    - `CONTAINS`, `REGEX`, `IN_LIST` - Pattern matching
    - `NUMERIC_TOLERANCE`, `DATE_TOLERANCE` - Range comparisons
    - `EXISTS`, `NOT_EXISTS` - Presence checks

    ---

    ## üîê Authentication

    All endpoints require Bearer token authentication via Supabase JWT.
    Admin endpoints require `role: admin` in JWT claims.

    ---

    ## üìö Additional Documentation

    - [BFF Pattern Architecture](/docs/architecture/BFF_PATTERN_ARCHITECTURE.md)
    - [Validation Backend Architecture](/docs/architecture/VALIDATION_BACKEND_ARCHITECTURE.md)
    - [ARES Integration Scope](/docs/architecture/ARES_VALIDATION_SCOPE.md)

  version: 1.1.0
  contact:
    name: SecureDealAI Team
    email: dev@aures.cz
  license:
    name: Proprietary

servers:
  - url: https://bdmygmbxtdgujkytpxha.supabase.co/functions/v1
    description: Production server
  - url: http://localhost:54321/functions/v1
    description: Local development

tags:
  - name: Architecture
    description: |
      Documentation endpoints explaining the BFF (Backend-for-Frontend) architecture.
      These endpoints return static documentation data for understanding system design.
  - name: Data Sources
    description: |
      Information about external data sources integrated into SecureDealAI.
      Includes ARES, ADIS, Mistral OCR, and internal database schemas.
  - name: Validation
    description: Execute and retrieve validation results
  - name: Rules
    description: CRUD operations for validation rules (Admin only)
  - name: Rule Lifecycle
    description: Activate, deactivate, and test rules
  - name: Import/Export
    description: Bulk operations for rules

paths:
  # ==========================================
  # Architecture Documentation Endpoints
  # ==========================================

  /architecture/overview:
    get:
      tags:
        - Architecture
      summary: BFF Architecture Overview
      description: |
        Returns a comprehensive overview of the Backend-for-Frontend (BFF) architecture
        used in SecureDealAI, including data source integrations, key design decisions,
        and how the current setup simulates the production Aures environment.

        **Note**: This is a documentation-only endpoint that returns static information
        about the system architecture.
      operationId: getArchitectureOverview
      responses:
        '200':
          description: Architecture overview
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArchitectureOverview'
              example:
                pattern_name: "Backend-for-Frontend (BFF)"
                description: "SecureDealAI implements a multi-function BFF architecture using Supabase Edge Functions (Deno/TypeScript)."
                key_principles:
                  - principle: "Data Aggregation"
                    implementation: "validation-run combines data from 7 DB tables + cached external APIs"
                  - principle: "Service Orchestration"
                    implementation: "ares-validate coordinates ARES REST + ADIS SOAP APIs"
                  - principle: "Graceful Degradation"
                    implementation: "Missing external data triggers ORANGE status, not failure"
                  - principle: "Caching Strategy"
                    implementation: "ARES data cached 24h, ADIS 4h to reduce API calls"
                bff_functions:
                  - name: "validation-run"
                    type: "PRIMARY_BFF"
                    aggregation_level: "HIGH"
                    data_sources: ["buying_opportunities", "vehicles", "vendors", "ocr_extractions", "ares_validations", "validation_rules"]
                    endpoint: "POST /functions/v1/validation-run"
                  - name: "ares-validate"
                    type: "SECONDARY_BFF"
                    aggregation_level: "HIGH"
                    data_sources: ["ARES API", "ADIS SOAP API", "Supabase DB"]
                    endpoint: "POST /functions/v1/ares-validate"
                  - name: "ocr-extract"
                    type: "ASYNC_BFF"
                    aggregation_level: "HIGH"
                    data_sources: ["Supabase Storage", "Mistral OCR API", "Supabase DB"]
                    endpoint: "POST /functions/v1/ocr-extract"
                production_simulation:
                  description: "The current Supabase-based architecture simulates Aures production deployment"
                  components_mapped:
                    - current: "Supabase Edge Functions"
                      production_equivalent: "Aures BFF API Layer"
                    - current: "Supabase PostgreSQL"
                      production_equivalent: "Aures Production Database"
                    - current: "ARES/ADIS APIs"
                      production_equivalent: "Same external registries"

  /architecture/flows/{flowName}:
    get:
      tags:
        - Architecture
      summary: Get Data Flow Diagram
      description: |
        Returns a detailed data flow diagram for a specific operation, showing
        how data moves through the BFF layer and which services are called.

        Includes step-by-step descriptions and a Mermaid-format sequence diagram.
      operationId: getDataFlow
      parameters:
        - name: flowName
          in: path
          required: true
          description: Name of the data flow to retrieve
          schema:
            type: string
            enum: [validation, ares-lookup, ocr-processing, vendor-verification]
      responses:
        '200':
          description: Data flow diagram
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataFlowDiagram'
              example:
                flow_name: "validation"
                description: "Complete validation flow aggregating manual input, OCR data, and ARES/ADIS registry data"
                steps:
                  - step: 1
                    action: "Frontend sends validation request"
                    source: "Vue.js Frontend"
                    target: "validation-run Edge Function"
                    data_exchanged: "{ buying_opportunity_id } OR { spz } OR { vin }"
                  - step: 2
                    action: "Load buying opportunity context"
                    source: "validation-run"
                    target: "Supabase DB"
                    data_exchanged: "buying_opportunities + vehicles + vendors"
                  - step: 3
                    action: "Load OCR extractions by SPZ"
                    source: "validation-run"
                    target: "Supabase DB"
                    data_exchanged: "ocr_extractions (ORV, OP, VTP)"
                  - step: 4
                    action: "Load cached ARES/ADIS data"
                    source: "validation-run"
                    target: "Supabase DB"
                    data_exchanged: "ares_validations.ares_data + dph_status"
                  - step: 5
                    action: "Execute validation engine"
                    source: "validation-run (engine.ts)"
                    target: "Internal processing"
                    data_exchanged: "Apply transforms ‚Üí comparators ‚Üí evaluate rules"
                  - step: 6
                    action: "Store results and return"
                    source: "validation-run"
                    target: "Supabase DB ‚Üí Frontend"
                    data_exchanged: "ValidationResult with overall_status"
                sequence_diagram_mermaid: |
                  sequenceDiagram
                      participant FE as Vue.js Frontend
                      participant BFF as validation-run
                      participant DB as Supabase DB
                      FE->>BFF: POST /validation-run {buying_opportunity_id}
                      BFF->>DB: Load buying_opportunity + vehicle + vendor
                      DB-->>BFF: Manual input data
                      BFF->>DB: Query ocr_extractions by SPZ
                      DB-->>BFF: ORV + OP + VTP extracted fields
                      BFF->>DB: Query cached ARES/ADIS
                      DB-->>BFF: Company + DPH data
                      Note over BFF: Execute validation engine
                      BFF->>DB: Store validation_results
                      BFF-->>FE: ValidationResult {overall_status}
        '404':
          $ref: '#/components/responses/NotFound'

  # ==========================================
  # Data Sources Documentation Endpoints
  # ==========================================

  /data-sources:
    get:
      tags:
        - Data Sources
      summary: List All Data Sources
      description: |
        Returns information about all external data sources integrated into SecureDealAI,
        including their endpoints, caching strategies, and the data they provide.
      operationId: listDataSources
      responses:
        '200':
          description: List of data sources
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSourceList'
              example:
                sources:
                  - name: "ARES API"
                    type: "REST_API"
                    base_url: "https://ares.gov.cz/ekonomicke-subjekty-v-be/rest"
                    used_by: ["ares-lookup", "ares-validate"]
                    cache_strategy:
                      enabled: true
                      ttl_hours: 24
                      storage: "ares_validations.ares_data"
                    data_provided:
                      - "Company legal name (obchodniJmeno)"
                      - "IƒåO (registration number)"
                      - "DIƒå (VAT ID)"
                      - "Company registration date"
                      - "Registered address"
                    fallback_behavior: "Continue validation with ORANGE status"
                  - name: "ADIS SOAP API (DPH Registry)"
                    type: "SOAP_API"
                    base_url: "https://adisspr.mfcr.cz/dpr/axis2/services/"
                    used_by: ["ares-validate"]
                    cache_strategy:
                      enabled: true
                      ttl_hours: 4
                      storage: "ares_validations.dph_status"
                    data_provided:
                      - "VAT payer status (active/inactive)"
                      - "Unreliable payer flag"
                      - "Registered bank accounts"
                    fallback_behavior: "Skip DPH checks; mark as WARNING"
                  - name: "Mistral OCR API"
                    type: "AI_SERVICE"
                    base_url: "https://api.mistral.ai/v1"
                    used_by: ["ocr-extract"]
                    cache_strategy:
                      enabled: false
                      storage: "ocr_extractions.extracted_data (permanent)"
                    data_provided:
                      - "ORV fields (VIN, SPZ, make, model)"
                      - "OP fields (personal ID, name)"
                      - "VTP fields (technical data)"
                    fallback_behavior: "Retry 3x with exponential backoff"

  /data-sources/{sourceName}:
    get:
      tags:
        - Data Sources
      summary: Get Data Source Details
      description: |
        Returns detailed information about a specific data source, including
        its integration pattern, request/response examples, and error handling.
      operationId: getDataSourceDetails
      parameters:
        - name: sourceName
          in: path
          required: true
          description: Name of the data source
          schema:
            type: string
            enum: [ares, adis, mistral-ocr, supabase-db, supabase-storage]
      responses:
        '200':
          description: Data source details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DataSourceDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /data-sources/integration-matrix:
    get:
      tags:
        - Data Sources
      summary: Get Integration Matrix
      description: |
        Returns a matrix showing which Edge Functions call which data sources,
        useful for understanding the overall system architecture at a glance.
      operationId: getIntegrationMatrix
      responses:
        '200':
          description: Integration matrix
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrationMatrix'
              example:
                functions:
                  - name: "validation-run"
                    integrations:
                      supabase_db: true
                      ares_api: false
                      adis_api: false
                      mistral_ocr: false
                      supabase_storage: false
                    notes: "Uses cached ARES/ADIS from DB, not direct API calls"
                  - name: "ares-validate"
                    integrations:
                      supabase_db: true
                      ares_api: true
                      adis_api: true
                      mistral_ocr: false
                      supabase_storage: false
                    notes: "Primary external API orchestrator"
                  - name: "ocr-extract"
                    integrations:
                      supabase_db: true
                      ares_api: false
                      adis_api: false
                      mistral_ocr: true
                      supabase_storage: true
                    notes: "Document processing pipeline"
                  - name: "ares-lookup"
                    integrations:
                      supabase_db: true
                      ares_api: true
                      adis_api: false
                      mistral_ocr: false
                      supabase_storage: false
                    notes: "Real-time lookup with cache"

  # ==========================================
  # Validation Endpoints
  # ==========================================

  /validate:
    post:
      tags:
        - Validation
      summary: Execute validation
      description: Run all active validation rules against a buying opportunity
      operationId: executeValidation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/ValidationRequestById'
                - $ref: '#/components/schemas/ValidationRequestBySpz'
            examples:
              byId:
                summary: By buying_opportunity_id
                value:
                  buying_opportunity_id: "550e8400-e29b-41d4-a716-446655440000"
              bySpz:
                summary: By SPZ
                value:
                  spz: "1AB2345"
      responses:
        '200':
          description: Validation completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /validate/{validationId}:
    get:
      tags:
        - Validation
      summary: Get validation result by ID
      operationId: getValidationById
      security:
        - bearerAuth: []
      parameters:
        - name: validationId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'
        '404':
          $ref: '#/components/responses/NotFound'

  /validate/spz/{spz}:
    get:
      tags:
        - Validation
      summary: Get latest validation by SPZ
      operationId: getLatestValidationBySpz
      security:
        - bearerAuth: []
      parameters:
        - name: spz
          in: path
          required: true
          schema:
            type: string
            pattern: '^[A-Z0-9]{1,8}$'
      responses:
        '200':
          description: Latest validation result for SPZ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationResult'

  /validate/spz/{spz}/history:
    get:
      tags:
        - Validation
      summary: Get validation history for SPZ
      operationId: getValidationHistory
      security:
        - bearerAuth: []
      parameters:
        - name: spz
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 10
            maximum: 100
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Validation history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationHistory'

  /rules:
    get:
      tags:
        - Rules
      summary: List all validation rules
      operationId: listRules
      security:
        - bearerAuth: []
      parameters:
        - name: active_only
          in: query
          schema:
            type: boolean
            default: false
        - name: category
          in: query
          schema:
            $ref: '#/components/schemas/RuleCategory'
        - name: severity
          in: query
          schema:
            $ref: '#/components/schemas/Severity'
        - name: phase
          in: query
          schema:
            $ref: '#/components/schemas/Phase'
        - name: vendor_type
          in: query
          description: Filter by vendor type applicability
          schema:
            $ref: '#/components/schemas/VendorType'
        - name: buying_type
          in: query
          description: Filter by buying type applicability
          schema:
            $ref: '#/components/schemas/BuyingType'
        - name: include_drafts
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of rules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleList'

    post:
      tags:
        - Rules
      summary: Create a new validation rule
      description: Creates a new rule as a draft. Use /rules/{id}/activate to activate.
      operationId: createRule
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRuleRequest'
            example:
              rule_definition:
                id: "VEH-008"
                name: "Color Match"
                description: "Vehicle color should match ORV"
                enabled: true
                source:
                  entity: "vehicle"
                  field: "barva"
                  transforms: ["UPPERCASE", "TRIM"]
                target:
                  entity: "ocr_orv"
                  field: "color"
                  transforms: ["UPPERCASE", "TRIM"]
                comparison:
                  type: "FUZZY"
                  threshold: 0.8
                severity: "WARNING"
                blockOnFail: false
                errorMessage:
                  cs: "Barva vozidla se li≈°√≠"
                  en: "Vehicle color differs"
                metadata:
                  category: "vehicle"
                  phase: "mvp"
                  priority: 24
      responses:
        '201':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleCreatedResponse'
        '400':
          $ref: '#/components/responses/SchemaValidationError'

  /rules/{ruleId}:
    get:
      tags:
        - Rules
      summary: Get rule by ID
      operationId: getRuleById
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ruleId'
      responses:
        '200':
          description: Rule details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleDetail'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags:
        - Rules
      summary: Update a rule
      description: Updates an existing rule. Creates a new version if rule is active.
      operationId: updateRule
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ruleId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRuleRequest'
      responses:
        '200':
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleUpdatedResponse'

    delete:
      tags:
        - Rules
      summary: Delete a rule
      description: Soft-deletes a rule. Use force=true to delete active rules.
      operationId: deleteRule
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ruleId'
        - name: force
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Rule deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleDeletedResponse'
        '409':
          $ref: '#/components/responses/Conflict'

  /rules/{ruleId}/activate:
    post:
      tags:
        - Rule Lifecycle
      summary: Activate a draft rule
      operationId: activateRule
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ruleId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                activation_note:
                  type: string
                  example: "Approved by QA team after testing"
      responses:
        '200':
          description: Rule activated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleActivatedResponse'

  /rules/{ruleId}/deactivate:
    post:
      tags:
        - Rule Lifecycle
      summary: Deactivate a rule
      operationId: deactivateRule
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ruleId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                deactivation_reason:
                  type: string
                  example: "Temporarily disabled for maintenance"
      responses:
        '200':
          description: Rule deactivated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleDeactivatedResponse'

  /rules/{ruleId}/test:
    post:
      tags:
        - Rule Lifecycle
      summary: Test a rule with sample data
      description: Execute a rule against sample data without saving results
      operationId: testRule
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ruleId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TestRuleRequest'
            example:
              test_data:
                vehicle:
                  vin: "YV1PZA3TCL1103985"
                  spz: "1AB2345"
                ocr_orv:
                  vin: "YV1PZA3TCL1103985"
                  registrationPlateNumber: "1AB2345"
      responses:
        '200':
          description: Test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TestRuleResponse'

  /rules/{ruleId}/history:
    get:
      tags:
        - Rules
      summary: Get rule change history
      operationId: getRuleHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/ruleId'
      responses:
        '200':
          description: Rule history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuleHistory'

  /rules/schema:
    get:
      tags:
        - Rules
      summary: Get JSON Schema for rule validation
      operationId: getRuleSchema
      security:
        - bearerAuth: []
      responses:
        '200':
          description: JSON Schema
          content:
            application/json:
              schema:
                type: object
                description: JSON Schema draft-07 for validation rules

  /rules/import:
    post:
      tags:
        - Import/Export
      summary: Bulk import rules
      operationId: importRules
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImportRulesRequest'
      responses:
        '200':
          description: Import result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportRulesResponse'

  /rules/export:
    get:
      tags:
        - Import/Export
      summary: Export all rules
      operationId: exportRules
      security:
        - bearerAuth: []
      parameters:
        - name: active_only
          in: query
          schema:
            type: boolean
            default: false
        - name: format
          in: query
          schema:
            type: string
            enum: [json, yaml]
            default: json
      responses:
        '200':
          description: Exported rules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportRulesResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token

  parameters:
    ruleId:
      name: ruleId
      in: path
      required: true
      description: Rule ID (e.g., VEH-001)
      schema:
        type: string
        pattern: '^[A-Z]{2,4}-[0-9]{3}$'

  schemas:
    # === Architecture Documentation Schemas ===

    ArchitectureOverview:
      type: object
      description: High-level overview of the BFF architecture
      properties:
        pattern_name:
          type: string
          description: Name of the architectural pattern
          example: "Backend-for-Frontend (BFF)"
        description:
          type: string
          description: Brief description of the architecture
        key_principles:
          type: array
          description: Core architectural principles and their implementations
          items:
            type: object
            properties:
              principle:
                type: string
                description: Name of the principle
              implementation:
                type: string
                description: How this principle is implemented
        bff_functions:
          type: array
          description: List of BFF Edge Functions
          items:
            $ref: '#/components/schemas/BffFunctionSummary'
        production_simulation:
          type: object
          description: How current setup maps to production Aures environment
          properties:
            description:
              type: string
            components_mapped:
              type: array
              items:
                type: object
                properties:
                  current:
                    type: string
                    description: Current component
                  production_equivalent:
                    type: string
                    description: Production equivalent

    BffFunctionSummary:
      type: object
      description: Summary of a BFF Edge Function
      properties:
        name:
          type: string
          description: Function name
          example: "validation-run"
        type:
          type: string
          enum: [PRIMARY_BFF, SECONDARY_BFF, ASYNC_BFF, UTILITY_BFF, CRUD, SERVICE]
          description: |
            BFF function type:
            - `PRIMARY_BFF` - Main aggregation function (highest complexity)
            - `SECONDARY_BFF` - External API orchestrator
            - `ASYNC_BFF` - Async processing handler
            - `UTILITY_BFF` - Cached lookup service
            - `CRUD` - Simple database CRUD
            - `SERVICE` - Utility service
        aggregation_level:
          type: string
          enum: [HIGH, MEDIUM, LOW]
          description: Level of data aggregation complexity
        data_sources:
          type: array
          items:
            type: string
          description: Data sources this function aggregates
        endpoint:
          type: string
          description: API endpoint path
          example: "POST /functions/v1/validation-run"

    DataFlowDiagram:
      type: object
      description: Detailed data flow for a specific operation
      properties:
        flow_name:
          type: string
          description: Name of the flow
          example: "validation"
        description:
          type: string
          description: What this flow accomplishes
        steps:
          type: array
          description: Step-by-step flow description
          items:
            type: object
            properties:
              step:
                type: integer
                description: Step number
              action:
                type: string
                description: What happens in this step
              source:
                type: string
                description: Origin of the action
              target:
                type: string
                description: Destination of the action
              data_exchanged:
                type: string
                description: Data moving in this step
        sequence_diagram_mermaid:
          type: string
          description: Mermaid-format sequence diagram for visualization

    DataSourceList:
      type: object
      description: List of all integrated data sources
      properties:
        sources:
          type: array
          items:
            $ref: '#/components/schemas/DataSourceIntegration'

    DataSourceIntegration:
      type: object
      description: Information about an integrated data source
      properties:
        name:
          type: string
          description: Human-readable name
          example: "ARES API"
        type:
          type: string
          enum: [REST_API, SOAP_API, DATABASE, STORAGE, AI_SERVICE]
          description: |
            Type of data source:
            - `REST_API` - RESTful HTTP API
            - `SOAP_API` - SOAP/XML-based API
            - `DATABASE` - Direct database connection
            - `STORAGE` - File/blob storage
            - `AI_SERVICE` - AI/ML service API
        base_url:
          type: string
          description: Base URL or connection info
          example: "https://ares.gov.cz/ekonomicke-subjekty-v-be/rest"
        used_by:
          type: array
          items:
            type: string
          description: Edge Functions that use this source
        cache_strategy:
          type: object
          description: Caching configuration
          properties:
            enabled:
              type: boolean
            ttl_hours:
              type: integer
              nullable: true
              description: Time-to-live in hours (null = permanent)
            storage:
              type: string
              description: Where cached data is stored
        data_provided:
          type: array
          items:
            type: string
          description: List of data fields this source provides
        fallback_behavior:
          type: string
          description: What happens when this source is unavailable

    DataSourceDetail:
      type: object
      description: Detailed information about a specific data source
      allOf:
        - $ref: '#/components/schemas/DataSourceIntegration'
        - type: object
          properties:
            authentication:
              type: object
              description: How authentication is handled
              properties:
                method:
                  type: string
                  enum: [API_KEY, BEARER_TOKEN, BASIC_AUTH, NONE]
                header_name:
                  type: string
            request_examples:
              type: array
              description: Example requests to this source
              items:
                type: object
                properties:
                  name:
                    type: string
                  method:
                    type: string
                  url:
                    type: string
                  description:
                    type: string
            response_examples:
              type: array
              description: Example responses from this source
              items:
                type: object
                properties:
                  name:
                    type: string
                  status:
                    type: integer
                  body:
                    type: object
            error_handling:
              type: object
              description: How errors are handled
              properties:
                retry_strategy:
                  type: string
                max_retries:
                  type: integer
                timeout_ms:
                  type: integer

    IntegrationMatrix:
      type: object
      description: Matrix showing which functions use which data sources
      properties:
        functions:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                description: Edge Function name
              integrations:
                type: object
                description: Boolean flags for each data source
                properties:
                  supabase_db:
                    type: boolean
                  ares_api:
                    type: boolean
                  adis_api:
                    type: boolean
                  mistral_ocr:
                    type: boolean
                  supabase_storage:
                    type: boolean
              notes:
                type: string
                description: Additional context about this function's integrations

    # === Request/Response Schemas ===

    ValidationRequestById:
      type: object
      required:
        - buying_opportunity_id
      properties:
        buying_opportunity_id:
          type: string
          format: uuid

    ValidationRequestBySpz:
      type: object
      required:
        - spz
      properties:
        spz:
          type: string
          pattern: '^[A-Z0-9]{1,8}$'

    ValidationResult:
      type: object
      properties:
        id:
          type: string
          format: uuid
        buying_opportunity_id:
          type: string
          format: uuid
        overall_status:
          $ref: '#/components/schemas/ValidationStatus'
        field_validations:
          type: array
          items:
            $ref: '#/components/schemas/FieldValidation'
        statistics:
          $ref: '#/components/schemas/ValidationStatistics'
        duration_ms:
          type: integer
        created_at:
          type: string
          format: date-time

    FieldValidation:
      type: object
      properties:
        rule_id:
          type: string
        field:
          type: string
        manual_value:
          type: string
          nullable: true
        ocr_value:
          type: string
          nullable: true
        result:
          type: string
          enum: [MATCH, MISMATCH, MISSING]
        severity:
          $ref: '#/components/schemas/Severity'
        status:
          $ref: '#/components/schemas/ValidationStatus'
        error_message:
          type: string
          nullable: true

    ValidationStatistics:
      type: object
      properties:
        total_rules_executed:
          type: integer
        rules_passed:
          type: integer
        rules_failed:
          type: integer
        rules_skipped:
          type: integer
        critical_issues:
          type: integer
        warning_issues:
          type: integer

    ValidationHistory:
      type: object
      properties:
        spz:
          type: string
        total_count:
          type: integer
        validations:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              overall_status:
                $ref: '#/components/schemas/ValidationStatus'
              created_at:
                type: string
                format: date-time

    # === Rule Schemas ===

    RuleList:
      type: object
      properties:
        total_count:
          type: integer
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleSummary'

    RuleSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        rule_id:
          type: string
        name:
          type: string
        severity:
          $ref: '#/components/schemas/Severity'
        is_active:
          type: boolean
        is_draft:
          type: boolean
        version:
          type: integer
        category:
          $ref: '#/components/schemas/RuleCategory'
        phase:
          $ref: '#/components/schemas/Phase'
        updated_at:
          type: string
          format: date-time

    RuleDetail:
      type: object
      properties:
        id:
          type: string
          format: uuid
        rule_id:
          type: string
        rule_definition:
          $ref: '#/components/schemas/RuleDefinition'
        is_active:
          type: boolean
        is_draft:
          type: boolean
        version:
          type: integer
        schema_version:
          type: string
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        activated_by:
          type: string
          nullable: true
        activated_at:
          type: string
          format: date-time
          nullable: true

    RuleDefinition:
      type: object
      required:
        - id
        - name
        - source
        - target
        - comparison
        - severity
      properties:
        id:
          type: string
          pattern: '^[A-Z]{2,4}-[0-9]{3}$'
          description: Unique rule identifier (e.g., VEH-001, ARES-002)
          example: "VEH-001"
        name:
          type: string
          minLength: 3
          maxLength: 100
          description: Human-readable rule name
          example: "VIN Match"
        description:
          type: string
          maxLength: 500
          description: Detailed description of what this rule validates
        enabled:
          type: boolean
          default: true
        source:
          $ref: '#/components/schemas/DataSource'
        target:
          $ref: '#/components/schemas/DataSource'
        comparison:
          $ref: '#/components/schemas/ComparisonConfig'
        severity:
          $ref: '#/components/schemas/Severity'
        blockOnFail:
          type: boolean
          default: false
        conditions:
          $ref: '#/components/schemas/ConditionGroup'
        errorMessage:
          $ref: '#/components/schemas/LocalizedMessage'
        metadata:
          $ref: '#/components/schemas/RuleMetadata'

    DataSource:
      type: object
      required:
        - entity
        - field
      properties:
        entity:
          type: string
          enum:
            - buying_opportunity
            - vehicle
            - vendor
            - ocr_orv
            - ocr_op
            - ocr_vtp
            - ares
            - adis
            - cebia
            - dolozky
          description: |
            Data entity/source type:
            - `buying_opportunity` - Context entity (buying_type, status)
            - `vehicle`, `vendor` - Manual input data
            - `ocr_orv`, `ocr_op`, `ocr_vtp` - OCR extractions from documents
            - `ares`, `adis`, `cebia`, `dolozky` - External registries
        field:
          type: string
          description: Field path within the entity (supports dot notation)
          example: "vin"
        transforms:
          type: array
          items:
            $ref: '#/components/schemas/Transform'
          default: []
          description: Transformations to apply before comparison

    Transform:
      type: string
      enum:
        - UPPERCASE
        - LOWERCASE
        - TRIM
        - REMOVE_SPACES
        - REMOVE_DIACRITICS
        - NORMALIZE_DATE
        - EXTRACT_NUMBER
        - FORMAT_RC
        - FORMAT_ICO
        - FORMAT_DIC
        - ADDRESS_NORMALIZE
        - NAME_NORMALIZE
        - VIN_NORMALIZE
        - SPZ_NORMALIZE
      description: |
        Data transformation functions:
        - `UPPERCASE/LOWERCASE` - Case conversion
        - `TRIM` - Remove leading/trailing whitespace
        - `REMOVE_SPACES` - Remove all spaces
        - `REMOVE_DIACRITICS` - Remove accents (ƒõ≈°ƒç≈ô≈æ√Ω√°√≠√© ‚Üí escrzyaie)
        - `NORMALIZE_DATE` - Convert to YYYY-MM-DD
        - `EXTRACT_NUMBER` - Extract numeric value
        - `FORMAT_RC` - Format Czech personal ID (rodn√© ƒç√≠slo)
        - `FORMAT_ICO` - Format company ID (8 digits with leading zeros)
        - `FORMAT_DIC` - Format VAT ID (CZ + 8-10 digits)
        - `ADDRESS_NORMALIZE` - Normalize street addresses
        - `NAME_NORMALIZE` - Normalize person/company names
        - `VIN_NORMALIZE` - Normalize VIN (17 chars, O‚Üí0, I‚Üí1)
        - `SPZ_NORMALIZE` - Normalize registration plate

    ComparisonConfig:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum:
            - EXACT
            - FUZZY
            - CONTAINS
            - REGEX
            - NUMERIC_TOLERANCE
            - DATE_TOLERANCE
            - EXISTS
            - NOT_EXISTS
            - IN_LIST
          description: |
            Comparison method:
            - `EXACT` - Exact string match
            - `FUZZY` - Levenshtein similarity (requires threshold)
            - `CONTAINS` - Source contains target
            - `REGEX` - Regex pattern match (requires pattern)
            - `NUMERIC_TOLERANCE` - Numeric comparison with tolerance
            - `DATE_TOLERANCE` - Date comparison with tolerance in days
            - `EXISTS` - Check if value exists
            - `NOT_EXISTS` - Check if value does NOT exist
            - `IN_LIST` - Value is in allowed list
        caseSensitive:
          type: boolean
          default: false
        threshold:
          type: number
          minimum: 0
          maximum: 1
          description: Similarity threshold for FUZZY match (0.0-1.0)
          example: 0.8
        tolerance:
          type: number
          description: Tolerance value for NUMERIC_TOLERANCE or days for DATE_TOLERANCE
        toleranceType:
          type: string
          enum: [absolute, percentage]
          default: absolute
        pattern:
          type: string
          description: Regex pattern for REGEX comparison
        allowedValues:
          type: array
          items:
            type: string
          description: Allowed values for IN_LIST comparison

    ConditionGroup:
      type: object
      required:
        - conditions
      properties:
        operator:
          type: string
          enum: [AND, OR]
          default: AND
          description: Logical operator for combining conditions
        conditions:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/Condition'

    Condition:
      type: object
      required:
        - field
        - operator
        - value
      properties:
        field:
          type: string
          description: Field path to evaluate (e.g., vendor.vendor_type)
          example: "vendor.vendor_type"
        operator:
          type: string
          enum:
            - EQUALS
            - NOT_EQUALS
            - EXISTS
            - NOT_EXISTS
            - IN
            - NOT_IN
            - GREATER_THAN
            - LESS_THAN
        value:
          description: Value to compare against

    LocalizedMessage:
      type: object
      required:
        - cs
        - en
      properties:
        cs:
          type: string
          description: Czech message
        en:
          type: string
          description: English message
        sk:
          type: string
          description: Slovak message
        pl:
          type: string
          description: Polish message

    RuleMetadata:
      type: object
      properties:
        category:
          $ref: '#/components/schemas/RuleCategory'
        phase:
          $ref: '#/components/schemas/Phase'
        requiresDocument:
          type: string
          enum: [ORV, OP, VTP]
          nullable: true
          deprecated: true
          description: "DEPRECATED: Use requiresDocuments or requiresDocumentGroup instead"
        requiresDocuments:
          type: array
          items:
            type: integer
          description: |
            Document Type IDs required for this rule. All specified documents must be present.
            Common IDs: 63=ORV (Mal√Ω technick√Ω pr≈Økaz), 1=OP (Obƒçansk√Ω pr≈Økaz),
            21=Technick√Ω pr≈Økaz, 116=Technick√Ω pr≈Økaz (BG)
          example: [63]
        requiresDocumentGroup:
          $ref: '#/components/schemas/DocumentGroup'
          description: Document group - rule applies if ANY document in the group is present
        applicableTo:
          type: array
          items:
            $ref: '#/components/schemas/VendorType'
          description: Vendor types this rule applies to (FO/PO)
        applicableToBuyingType:
          type: array
          items:
            $ref: '#/components/schemas/BuyingType'
          description: Buying types this rule applies to (BRANCH = default MVP, MOBILE_BUYING = Phase 2)
        priority:
          type: integer
          minimum: 1
          maximum: 100
          default: 50
        tags:
          type: array
          items:
            type: string

    # === Enums ===

    ValidationStatus:
      type: string
      enum: [GREEN, ORANGE, RED]
      description: |
        - `GREEN` - All validations passed
        - `ORANGE` - Warnings or missing data, manual review needed
        - `RED` - Critical validation failed, blocked

    Severity:
      type: string
      enum: [CRITICAL, WARNING, INFO]
      description: |
        - `CRITICAL` - RED on fail, blocks process
        - `WARNING` - ORANGE on fail, needs review
        - `INFO` - Logged only, no impact

    RuleCategory:
      type: string
      enum: [vehicle, vendor_fo, vendor_po, cross, external]
      description: Rule category for grouping

    Phase:
      type: string
      enum: [mvp, phase2, future]
      description: Implementation phase

    VendorType:
      type: string
      enum: [PHYSICAL_PERSON, COMPANY]
      description: |
        Vendor type for rule filtering:
        - `PHYSICAL_PERSON` - Individual seller (FO)
        - `COMPANY` - Company seller (PO)

    BuyingType:
      type: string
      enum: [BRANCH, MOBILE_BUYING]
      description: |
        Buying type for rule filtering:
        - `BRANCH` - Standard branch purchase (MVP default)
        - `MOBILE_BUYING` - Mobile buying (Phase 2)

    DocumentGroup:
      type: string
      enum: [VTP, ORV, OP]
      description: |
        Document group for rule filtering. Rule applies if ANY document in the group is present:
        - `VTP` - Technicky prukaz (Document Type IDs: 21, 116)
        - `ORV` - Maly technicky prukaz (Document Type ID: 63)
        - `OP` - Obcansky prukaz (Document Type ID: 1)

    # === CRUD Response Schemas ===

    CreateRuleRequest:
      type: object
      required:
        - rule_definition
      properties:
        rule_definition:
          $ref: '#/components/schemas/RuleDefinition'

    RuleCreatedResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        rule_id:
          type: string
        is_draft:
          type: boolean
        is_active:
          type: boolean
        version:
          type: integer
        message:
          type: string

    UpdateRuleRequest:
      type: object
      required:
        - rule_definition
      properties:
        rule_definition:
          $ref: '#/components/schemas/RuleDefinition'
        change_reason:
          type: string

    RuleUpdatedResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        rule_id:
          type: string
        version:
          type: integer
        previous_version_id:
          type: string
          format: uuid
        is_draft:
          type: boolean
        message:
          type: string

    RuleDeletedResponse:
      type: object
      properties:
        rule_id:
          type: string
        deleted:
          type: boolean
        message:
          type: string

    RuleActivatedResponse:
      type: object
      properties:
        rule_id:
          type: string
        is_active:
          type: boolean
        is_draft:
          type: boolean
        activated_at:
          type: string
          format: date-time
        activated_by:
          type: string

    RuleDeactivatedResponse:
      type: object
      properties:
        rule_id:
          type: string
        is_active:
          type: boolean
        deactivated_at:
          type: string
          format: date-time

    TestRuleRequest:
      type: object
      required:
        - test_data
      properties:
        test_data:
          type: object
          description: Sample data organized by entity type
          additionalProperties:
            type: object

    TestRuleResponse:
      type: object
      properties:
        rule_id:
          type: string
        test_result:
          type: object
          properties:
            result:
              type: string
              enum: [MATCH, MISMATCH, MISSING]
            status:
              $ref: '#/components/schemas/ValidationStatus'
            source_value:
              type: string
            target_value:
              type: string
            normalized_source:
              type: string
            normalized_target:
              type: string
        executed_at:
          type: string
          format: date-time

    RuleHistory:
      type: object
      properties:
        rule_id:
          type: string
        history:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              change_type:
                type: string
                enum: [CREATE, UPDATE, ACTIVATE, DEACTIVATE, DELETE]
              changed_by:
                type: string
              changed_at:
                type: string
                format: date-time
              change_reason:
                type: string

    ImportRulesRequest:
      type: object
      required:
        - rules
      properties:
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleDefinition'
        options:
          type: object
          properties:
            skip_existing:
              type: boolean
              default: true
            activate_on_import:
              type: boolean
              default: false

    ImportRulesResponse:
      type: object
      properties:
        imported:
          type: integer
        skipped:
          type: integer
        errors:
          type: integer
        details:
          type: array
          items:
            type: object
            properties:
              rule_id:
                type: string
              status:
                type: string
                enum: [imported, skipped, error]
              reason:
                type: string
              id:
                type: string
                format: uuid

    ExportRulesResponse:
      type: object
      properties:
        version:
          type: string
        exported_at:
          type: string
          format: date-time
        rules:
          type: array
          items:
            $ref: '#/components/schemas/RuleDefinition'

    # === Error Schemas ===

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string

    SchemaValidationError:
      type: object
      properties:
        error:
          type: string
          example: validation_error
        message:
          type: string
          example: Rule definition does not match schema
        details:
          type: array
          items:
            type: object
            properties:
              path:
                type: string
                example: "$.comparison.threshold"
              message:
                type: string
                example: "threshold must be between 0 and 1"

  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: validation_error
            message: Missing required parameter
            code: MISSING_PARAMETER

    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: unauthorized
            message: Missing or invalid token
            code: UNAUTHORIZED

    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: not_found
            message: Resource not found
            code: NOT_FOUND

    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: conflict
            message: Cannot delete active rule. Deactivate first or use force=true
            code: CONFLICT

    SchemaValidationError:
      description: Schema Validation Error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/SchemaValidationError'
